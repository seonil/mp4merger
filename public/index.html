<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동영상 편집 도구</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        header {
            padding: 24px 32px;
            border-bottom: 1px solid #e0e0e0;
        }

        h1 {
            font-size: 20px;
            font-weight: 500;
            color: #000;
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 13px;
            color: #666;
            font-weight: 400;
        }

        main {
            padding: 32px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #000;
        }

        .folder-browser {
            border: 1px solid #ddd;
            border-radius: 2px;
            margin-bottom: 16px;
        }

        .current-path {
            padding: 12px 16px;
            background: #fafafa;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .folder-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
            display: flex;
            align-items: center;
        }

        .folder-item:hover {
            background: #fafafa;
        }

        .folder-item:last-child {
            border-bottom: none;
        }

        .folder-icon {
            margin-right: 8px;
            color: #999;
        }

        button {
            background: #000;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 2px;
            font-weight: 400;
            transition: opacity 0.15s;
        }

        button:hover {
            opacity: 0.8;
        }

        button:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            opacity: 1;
        }

        button.secondary {
            background: white;
            color: #000;
            border: 1px solid #ddd;
        }

        button.secondary:hover {
            background: #fafafa;
            opacity: 1;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sort-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .video-list {
            border: 1px solid #ddd;
            border-radius: 2px;
            margin-top: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        .video-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
        }

        .video-item:hover {
            background: #fafafa;
        }

        .video-item:last-child {
            border-bottom: none;
        }

        .video-item input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .video-info {
            flex: 1;
        }

        .video-name {
            font-size: 13px;
            color: #000;
            margin-bottom: 4px;
        }

        .video-size {
            font-size: 12px;
            color: #999;
        }

        .video-actions {
            display: flex;
            gap: 8px;
        }

        .video-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 48px;
            color: #999;
            font-size: 13px;
        }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 2px;
            font-size: 13px;
            display: none;
            border-left: 3px solid;
        }

        .status.success {
            background: #f0f9f0;
            color: #2e7d32;
            border-left-color: #2e7d32;
            display: block;
        }

        .status.error {
            background: #fef0f0;
            color: #c62828;
            border-left-color: #c62828;
            display: block;
        }

        .status.info {
            background: #f0f4f9;
            color: #1565c0;
            border-left-color: #1565c0;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 2px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .path-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 13px;
            font-family: inherit;
        }

        .path-input:focus {
            outline: none;
            border-color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>동영상 편집 도구</h1>
            <p class="subtitle">MP4 동영상 병합 및 자르기</p>
        </header>

        <main>
            <div class="section">
                <div class="section-title">폴더 선택</div>
                <div class="folder-browser">
                    <div class="current-path">
                        <span id="currentPath">폴더를 선택하세요</span>
                        <button class="secondary" onclick="goUpFolder()">↑ 상위 폴더</button>
                    </div>
                    <div class="folder-list" id="folderList">
                        <div class="empty-state">폴더 찾아보기를 시작하세요</div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="secondary" onclick="startBrowsing()">폴더 찾아보기</button>
                    <button class="secondary" onclick="showManualPath()">직접 입력</button>
                    <button onclick="loadVideos()">동영상 불러오기</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">동영상 목록</div>
                <div class="controls">
                    <select class="sort-select" id="sortSelect" onchange="sortVideos()">
                        <option value="name">이름순</option>
                        <option value="date">날짜순</option>
                        <option value="size">크기순</option>
                    </select>
                    <button class="secondary" onclick="selectAll()">전체 선택</button>
                    <button class="secondary" onclick="deselectAll()">선택 해제</button>
                    <button onclick="showMergeModal()" id="mergeBtn" disabled>선택 항목 병합</button>
                </div>
                <div class="button-group" style="margin-top: 12px;">
                    <button class="secondary" onclick="showSpeedModal(2)" id="speed2Btn" disabled>2배속</button>
                    <button class="secondary" onclick="showSpeedModal(4)" id="speed4Btn" disabled>4배속</button>
                    <button class="secondary" onclick="showSpeedModal(8)" id="speed8Btn" disabled>8배속</button>
                    <button class="secondary" onclick="showTimelapseModal()" id="timelapseBtn" disabled>타임랩스</button>
                </div>
                <div class="video-list" id="videoList">
                    <div class="empty-state">폴더에서 동영상을 불러오세요</div>
                </div>
            </div>

            <div class="status" id="status"></div>
        </main>
    </div>

    <!-- Manual Path Input Modal -->
    <div class="modal" id="pathModal">
        <div class="modal-content">
            <div class="modal-title">폴더 경로 입력</div>
            <input type="text" class="path-input" id="manualPath" placeholder="예: C:\Videos 또는 /home/user/videos">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('pathModal')">취소</button>
                <button onclick="setManualPath()">확인</button>
            </div>
        </div>
    </div>

    <!-- Output Folder Modal -->
    <div class="modal" id="outputModal">
        <div class="modal-content">
            <div class="modal-title">저장 위치 선택</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">병합된 파일을 저장할 위치를 선택하세요.</p>
            <input type="text" class="path-input" id="outputPath" placeholder="비워두면 원본 폴더에 저장됩니다">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('outputModal')">취소</button>
                <button onclick="executeMerge()">병합 시작</button>
            </div>
        </div>
    </div>

    <!-- Trim Output Folder Modal -->
    <div class="modal" id="trimOutputModal">
        <div class="modal-content">
            <div class="modal-title">저장 위치 선택</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;">자른 파일을 저장할 위치를 선택하세요.</p>
            <input type="text" class="path-input" id="trimOutputPath" placeholder="비워두면 원본 폴더에 저장됩니다">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('trimOutputModal')">취소</button>
                <button onclick="executeTrim()">자르기 시작</button>
            </div>
        </div>
    </div>

    <!-- Speed Change Modal -->
    <div class="modal" id="speedModal">
        <div class="modal-content">
            <div class="modal-title">속도 변경</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 16px;" id="speedModalText">선택한 파일을 2배속으로 변환합니다.</p>
            <input type="text" class="path-input" id="speedOutputPath" placeholder="비워두면 원본 폴더에 저장됩니다">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('speedModal')">취소</button>
                <button onclick="executeSpeed()">변환 시작</button>
            </div>
        </div>
    </div>

    <!-- Timelapse Modal -->
    <div class="modal" id="timelapseModal">
        <div class="modal-content">
            <div class="modal-title">타임랩스 생성</div>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">타임랩스 FPS를 선택하세요 (오디오 제거됨)</p>
            <select class="sort-select" id="timelapseFps" style="width: 100%; margin-bottom: 16px;">
                <option value="30">30 FPS (빠름)</option>
                <option value="60" selected>60 FPS (권장)</option>
                <option value="120">120 FPS (매우 빠름)</option>
                <option value="240">240 FPS (초고속)</option>
            </select>
            <input type="text" class="path-input" id="timelapseOutputPath" placeholder="비워두면 원본 폴더에 저장됩니다">
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('timelapseModal')">취소</button>
                <button onclick="executeTimelapse()">생성 시작</button>
            </div>
        </div>
    </div>

    <script>
        let videos = [];
        let currentFolder = '';
        let currentPath = '';
        let currentTrimVideo = '';
        let currentSpeed = 2;

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showManualPath() {
            showModal('pathModal');
        }

        function setManualPath() {
            const path = document.getElementById('manualPath').value.trim();
            if (path) {
                currentFolder = path;
                currentPath = path;
                document.getElementById('currentPath').textContent = path;
                closeModal('pathModal');
            }
        }

        function startBrowsing() {
            // Start browsing from home directory
            browseFolders();
        }

        async function browseFolders(path) {
            try {
                const url = path ? `/api/browse?path=${encodeURIComponent(path)}` : '/api/browse';
                const response = await fetch(url);

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || '폴더를 불러올 수 없습니다');
                }

                const data = await response.json();

                currentPath = data.current;
                document.getElementById('currentPath').textContent = currentPath;

                const listEl = document.getElementById('folderList');
                if (data.folders.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">하위 폴더가 없습니다</div>';
                } else {
                    listEl.innerHTML = data.folders.map(folder => `
                        <div class="folder-item" onclick="browseFolders('${folder.path.replace(/\\/g, '\\\\')}')">
                            <span class="folder-icon">📁</span>
                            ${folder.name}
                        </div>
                    `).join('');
                }

                currentFolder = currentPath;
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function goUpFolder() {
            if (!currentPath) {
                showStatus('먼저 폴더를 선택하세요', 'error');
                return;
            }
            const separator = currentPath.includes('\\') ? '\\' : '/';
            const parts = currentPath.split(/[/\\]/);

            if (parts.length > 1) {
                const parent = parts.slice(0, -1).join(separator);
                if (parent) {
                    await browseFolders(parent);
                }
            }
        }

        async function loadVideos() {
            if (!currentFolder) {
                showStatus('폴더를 먼저 선택하세요', 'error');
                return;
            }

            showStatus('동영상 불러오는 중...', 'info');

            try {
                const response = await fetch(`/api/videos?folder=${encodeURIComponent(currentFolder)}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '동영상을 불러올 수 없습니다');
                }

                videos = data;
                sortVideos();
                showStatus(`${videos.length}개 동영상을 불러왔습니다`, 'success');
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            }
        }

        function sortVideos() {
            const sortBy = document.getElementById('sortSelect').value;

            const sorted = [...videos].sort((a, b) => {
                if (sortBy === 'name') {
                    return a.name.localeCompare(b.name);
                } else if (sortBy === 'date') {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                } else if (sortBy === 'size') {
                    return b.size - a.size;
                }
                return 0;
            });

            videos = sorted;
            renderVideos();
        }

        function renderVideos() {
            const listEl = document.getElementById('videoList');

            if (videos.length === 0) {
                listEl.innerHTML = '<div class="empty-state">이 폴더에 MP4 파일이 없습니다</div>';
                return;
            }

            listEl.innerHTML = videos.map((video, index) => `
                <div class="video-item">
                    <input type="checkbox" id="video-${index}" onclick="event.stopPropagation(); updateMergeButton()">
                    <div class="video-info" onclick="toggleVideo(${index})">
                        <div class="video-name">${video.name}</div>
                        <div class="video-size">${formatBytes(video.size)}</div>
                    </div>
                    <div class="video-actions">
                        <button class="secondary" onclick="event.stopPropagation(); trimVideo('${video.name}')">
                            앞 30초 자르기
                        </button>
                    </div>
                </div>
            `).join('');

            updateMergeButton();
        }

        function toggleVideo(index) {
            const checkbox = document.getElementById(`video-${index}`);
            checkbox.checked = !checkbox.checked;
            updateMergeButton();
        }

        function selectAll() {
            videos.forEach((_, index) => {
                const checkbox = document.getElementById(`video-${index}`);
                if (checkbox) checkbox.checked = true;
            });
            updateMergeButton();
        }

        function deselectAll() {
            videos.forEach((_, index) => {
                const checkbox = document.getElementById(`video-${index}`);
                if (checkbox) checkbox.checked = false;
            });
            updateMergeButton();
        }

        function updateMergeButton() {
            const selectedCount = videos.filter((_, index) => {
                const checkbox = document.getElementById(`video-${index}`);
                return checkbox && checkbox.checked;
            }).length;

            const mergeBtn = document.getElementById('mergeBtn');
            mergeBtn.disabled = selectedCount < 2;

            // Update speed buttons
            const speed2Btn = document.getElementById('speed2Btn');
            const speed4Btn = document.getElementById('speed4Btn');
            const speed8Btn = document.getElementById('speed8Btn');
            const timelapseBtn = document.getElementById('timelapseBtn');
            const hasSelection = selectedCount > 0;

            speed2Btn.disabled = !hasSelection;
            speed4Btn.disabled = !hasSelection;
            speed8Btn.disabled = !hasSelection;
            timelapseBtn.disabled = !hasSelection;
        }

        function showMergeModal() {
            showModal('outputModal');
        }

        async function executeMerge() {
            const selectedVideos = videos
                .filter((_, index) => {
                    const checkbox = document.getElementById(`video-${index}`);
                    return checkbox && checkbox.checked;
                })
                .map(v => v.name);

            if (selectedVideos.length < 2) {
                showStatus('최소 2개 이상의 동영상을 선택하세요', 'error');
                return;
            }

            const outputFolder = document.getElementById('outputPath').value.trim() || null;
            closeModal('outputModal');

            showStatus('동영상 병합 중... 시간이 걸릴 수 있습니다.', 'info');
            document.getElementById('mergeBtn').disabled = true;

            try {
                const response = await fetch('/api/merge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videos: selectedVideos,
                        folder: currentFolder,
                        outputFolder: outputFolder
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '병합에 실패했습니다');
                }

                showStatus(`완료! 파일: ${data.outputFile}\n위치: ${data.outputPath}`, 'success');
                document.getElementById('outputPath').value = '';
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            } finally {
                updateMergeButton();
            }
        }

        function trimVideo(videoName) {
            currentTrimVideo = videoName;
            showModal('trimOutputModal');
        }

        async function executeTrim() {
            const outputFolder = document.getElementById('trimOutputPath').value.trim() || null;
            closeModal('trimOutputModal');

            showStatus(`"${currentTrimVideo}" 자르는 중...`, 'info');

            try {
                const response = await fetch('/api/trim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video: currentTrimVideo,
                        folder: currentFolder,
                        outputFolder: outputFolder
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '자르기에 실패했습니다');
                }

                showStatus(`완료! 파일: ${data.outputFile}\n위치: ${data.outputPath}`, 'success');
                document.getElementById('trimOutputPath').value = '';
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            }
        }

        function showSpeedModal(speed) {
            currentSpeed = speed;
            document.getElementById('speedModalText').textContent = `선택한 파일을 ${speed}배속으로 변환합니다.`;
            showModal('speedModal');
        }

        async function executeSpeed() {
            const selectedVideos = videos
                .filter((_, index) => {
                    const checkbox = document.getElementById(`video-${index}`);
                    return checkbox && checkbox.checked;
                })
                .map(v => v.name);

            if (selectedVideos.length === 0) {
                showStatus('최소 1개 이상의 동영상을 선택하세요', 'error');
                return;
            }

            const outputFolder = document.getElementById('speedOutputPath').value.trim() || null;
            closeModal('speedModal');

            showStatus(`동영상 ${currentSpeed}배속 변환 중... 시간이 걸릴 수 있습니다.`, 'info');
            document.getElementById('speed2Btn').disabled = true;
            document.getElementById('speed4Btn').disabled = true;
            document.getElementById('speed8Btn').disabled = true;

            try {
                const response = await fetch('/api/speedup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videos: selectedVideos,
                        folder: currentFolder,
                        speed: currentSpeed,
                        outputFolder: outputFolder
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '속도 변경에 실패했습니다');
                }

                showStatus(`완료! ${data.processed}개 파일 처리됨\n위치: ${data.outputPath}`, 'success');
                document.getElementById('speedOutputPath').value = '';
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            } finally {
                updateMergeButton();
            }
        }

        function showTimelapseModal() {
            showModal('timelapseModal');
        }

        async function executeTimelapse() {
            const selectedVideos = videos
                .filter((_, index) => {
                    const checkbox = document.getElementById(`video-${index}`);
                    return checkbox && checkbox.checked;
                })
                .map(v => v.name);

            if (selectedVideos.length === 0) {
                showStatus('최소 1개 이상의 동영상을 선택하세요', 'error');
                return;
            }

            const fps = parseInt(document.getElementById('timelapseFps').value);
            const outputFolder = document.getElementById('timelapseOutputPath').value.trim() || null;
            closeModal('timelapseModal');

            showStatus(`타임랩스 생성 중... 시간이 걸릴 수 있습니다.`, 'info');
            document.getElementById('timelapseBtn').disabled = true;

            try {
                const response = await fetch('/api/timelapse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videos: selectedVideos,
                        folder: currentFolder,
                        fps: fps,
                        outputFolder: outputFolder
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '타임랩스 생성에 실패했습니다');
                }

                showStatus(`완료! ${data.processed}개 파일 처리됨\n위치: ${data.outputPath}`, 'success');
                document.getElementById('timelapseOutputPath').value = '';
            } catch (error) {
                showStatus('오류: ' + error.message, 'error');
                console.error(error);
            } finally {
                updateMergeButton();
            }
        }
    </script>
</body>
</html>